import{_ as ie}from"./capacitor-vendor-BTR4nWhn.js";import{r as i,j as e,X as re}from"./react-vendor-BHHocIEL.js";import{i as le}from"./index-Drd8Gxze.js";import"./form-vendor-Cug7ZpG1.js";import"./ui-vendor-BA32w1ww.js";import"./supabase-vendor-59_sf5rX.js";const he=({recipe:r,onExit:P})=>{var Q,G,_;const[a,j]=i.useState(0),[T,$]=i.useState(!1),[f,N]=i.useState(!1),[X,oe]=i.useState(!1),[C,F]=i.useState(""),[O,z]=i.useState(!1),[w,y]=i.useState([]),R=i.useRef(null),u=i.useRef(null),S=i.useRef(a),d=i.useRef(!1);i.useRef(!1);const E=i.useRef({time:0,lastCmd:""});i.useRef(!1),i.useRef(!1);const I=i.useRef(!1),{toast:m}=le();i.useEffect(()=>{S.current=a},[a]),i.useEffect(()=>{d.current=f},[f]),i.useEffect(()=>{const s="webkitSpeechRecognition"in window||"SpeechRecognition"in window;z(s)},[]),i.useEffect(()=>(w.some(s=>s.isRunning)&&(R.current=setInterval(()=>{y(s=>s.map(t=>{if(!t.isRunning||t.remainingSeconds<=0)return t;const n=t.remainingSeconds-1;return n<=0?(B(),m({title:"Timer Complete!",description:`Step ${t.stepNumber} timer finished`}),{...t,remainingSeconds:0,isRunning:!1}):{...t,remainingSeconds:n}}))},1e3)),()=>{R.current&&clearInterval(R.current)}),[w]);const D=s=>{const t=new Set,n=/(\d+)(?:-(\d+))?\s*(?:more\s+)?(?:minute|min|mins|minutes|hour|hours|hr|hrs)/gi;let o;for(;(o=n.exec(s))!==null;){const c=parseInt(o[1]),x=o[2]?parseInt(o[2]):null,b=o[0].toLowerCase(),g=b.includes("hour")||b.includes("hr"),l=x||c,h=g?l*60:l;t.add(h)}return Array.from(t)},B=()=>{const s=new(window.AudioContext||window.webkitAudioContext),t=s.createOscillator(),n=s.createGain();t.connect(n),n.connect(s.destination),t.frequency.value=800,t.type="sine",n.gain.value=.3,t.start(),setTimeout(()=>t.stop(),300)},U=(s,t)=>{const n=`timer-${Date.now()}`,o=t*60;y(c=>[...c,{id:n,stepNumber:s,totalSeconds:o,remainingSeconds:o,isRunning:!0}]),m({title:"Timer Started",description:`${t} minute${t>1?"s":""} for Step ${s}`})},q=s=>{y(t=>t.map(n=>n.id===s?{...n,isRunning:!1}:n))},H=s=>{y(t=>t.map(n=>n.id===s?{...n,isRunning:!0}:n))},Y=s=>{y(t=>t.filter(n=>n.id!==s))},J=s=>{const t=Math.floor(s/60),n=s%60;return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},p=async s=>{console.log("ğŸ”Š [FINAL-FIX] Speaking:",s.substring(0,50));const t=d.current;if(u.current)try{u.current.stop(),u.current=null,console.log("ğŸ›‘ [FINAL-FIX] Mic stopped for TTS")}catch{console.log("Mic already stopped")}try{const{TextToSpeech:n}=await ie(async()=>{const{TextToSpeech:o}=await import("./capacitor-vendor-BTR4nWhn.js").then(c=>c.f);return{TextToSpeech:o}},[]);await n.speak({text:s,lang:"en-US",rate:.9,pitch:1,volume:1,category:"playback"}),console.log("âœ… [FINAL-FIX] TTS done"),console.log("ğŸ“Š [DEBUG] speakText called - wasListening:",t,"isListeningRef:",d.current),t?(console.log("ğŸ”„ [WAKE] Restarting wake word detection after TTS..."),setTimeout(()=>{k()},500)):console.log("âš ï¸ [WAKE] NOT restarting - wasListening is false")}catch(n){console.error("âŒ [FINAL-FIX] TTS error:",n)}},Z=s=>{var o,c,x,b,g;const t=s.toLowerCase().trim();console.log("ğŸ¯ Command received:",t),console.log("ğŸ“ Call stack:",(o=new Error().stack)==null?void 0:o.split(`
`)[2]);const n=Date.now();if(n-E.current.time<1e3&&t===E.current.lastCmd){console.log("â¸ï¸ BLOCKED by cooldown");return}if(E.current={time:n,lastCmd:t},F(t),setTimeout(()=>F(""),3e3),console.log("âœ… Command EXECUTING:",t),t.includes("next")){const l=Math.min(S.current+1,r.instructions.length-1);j(l);const h=((c=r.instructions[l])==null?void 0:c.replace(/^\d+\.\s*/,"").replace(/\[|\]/g,""))||"",v=l===r.instructions.length-1?"Final step.":`Step ${l+1}.`;p(`${v} ${h}`),m({title:`â¡ï¸ Step ${l+1}`})}else if(t.includes("back")||t.includes("previous")){const l=Math.max(S.current-1,0);j(l);const h=((x=r.instructions[l])==null?void 0:x.replace(/^\d+\.\s*/,"").replace(/\[|\]/g,""))||"";p(`Step ${l+1}. ${h}`),m({title:`â¬…ï¸ Step ${l+1}`})}else if(t.includes("start")&&(t.includes("recipe")||t.includes("cooking"))){j(0);const l=((b=r.instructions[0])==null?void 0:b.replace(/^\d+\.\s*/,"").replace(/\[|\]/g,""))||"";p(`Starting ${r.name}. Step 1. ${l}`),m({title:"ğŸ Starting Recipe"})}else if(t.includes("repeat")){const l=S.current,h=((g=r.instructions[l])==null?void 0:g.replace(/^\d+\.\s*/,"").replace(/\[|\]/g,""))||"";p(`Step ${l+1}. ${h}`),m({title:"ğŸ” Repeating"})}else if(t.includes("timer")){const l=S.current,h=r.instructions[l]||"",v=D(h);v.length>0?(U(l+1,v[0]),p(`Timer started for ${v[0]} minutes`)):p("No timer found in this step")}},k=()=>{if(!d.current){console.log("âš ï¸ [WAKE] Voice control is OFF");return}try{console.log("ğŸ¤ [CONTINUOUS] Starting continuous listening...");const s=window.SpeechRecognition||window.webkitSpeechRecognition,t=new s;t.continuous=!0,t.interimResults=!0,t.lang="en-US",t.onstart=()=>{N(!0),console.log('ğŸ‘‚ [CONTINUOUS] Listening continuously for "Quick Dish"...')},t.onresult=n=>{for(let o=n.resultIndex;o<n.results.length;o++){const c=n.results[o];if(c&&c[0]){const x=c[0].transcript.toLowerCase().trim();c.isFinal&&(console.log("ğŸ¯ [CONTINUOUS] Final heard:",x),x.includes("quick dish")||x.includes("quickdish")?(console.log("âœ… [CONTINUOUS] Wake word detected! Processing command..."),Z(x)):console.log("âŒ [CONTINUOUS] No wake word - ignoring"))}}},t.onend=()=>{console.log("ğŸ”„ [WAKE] Mic session ended - AUTO RESTARTING"),u.current=null,d.current?setTimeout(()=>k(),100):N(!1)},t.onerror=n=>{console.error("âŒ [WAKE] Error:",n.error),n.error!=="aborted"&&d.current&&(console.log("ğŸ”„ [WAKE] Error, restarting immediately..."),setTimeout(()=>k(),100))},t.start(),u.current=t}catch(s){console.error("âŒ [WAKE] Failed to start:",s),m({title:"Voice control failed",variant:"destructive"}),N(!1)}},ee=async()=>{if(!O){m({title:"Voice not supported",variant:"destructive"});return}if(d.current){console.log("ğŸ”´ [AUTO] Stopping voice control"),d.current=!1,N(!1),u.current&&(u.current.stop(),u.current=null),m({title:"Voice OFF"});return}console.log("ğŸ¤ [AUTO] Starting hands-free mode"),d.current=!0,N(!0),k(),m({title:"ğŸ¤ Voice Control ON",description:'Say "Quick Dish" to wake up'})};i.useEffect(()=>{if("wakeLock"in navigator){let s=null;return navigator.wakeLock.request("screen").then(t=>s=t).catch(t=>{}),()=>s==null?void 0:s.release()}},[]),i.useEffect(()=>{const s=t=>{T||((t.key==="ArrowRight"||t.key===" ")&&(t.preventDefault(),W()),t.key==="ArrowLeft"&&(t.preventDefault(),V()),t.key==="Escape"&&L())};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[a,T]),i.useEffect(()=>{r.instructions.length!==0&&(a===r.instructions.length-1?I.current||(I.current=!0,m({title:"Cooking complete! Enjoy! ğŸ‰"})):I.current=!1)},[a,r.instructions.length]);const W=()=>{j(s=>s<r.instructions.length-1?s+1:(d.current&&p("Cooking complete! Enjoy your meal!"),m({title:"Cooking complete! Enjoy! ğŸ‰"}),s))},V=()=>{j(s=>Math.max(0,s-1))},L=async()=>{if(d.current&&(N(!1),d.current=!1,u.current))try{u.current.abort(),u.current=null}catch{}P()},te=s=>{const t=[],n=s.toLowerCase();return r.ingredients.forEach(o=>{const c=o.item.toLowerCase();(c.split(/[\s,]+/).filter(g=>g.length>2).some(g=>n.includes(g))||n.includes(c))&&t.push(o)}),t},A=((Q=r.instructions[a])==null?void 0:Q.replace(/^\d+\.\s*/,"").replace(/\[|\]/g,""))||"",K=te(A),se=(a+1)/r.instructions.length*100,M=D(A),ne=w.some(s=>s.stepNumber===a+1&&s.remainingSeconds>0);return T?e.jsxs("div",{className:"fixed inset-0 bg-white z-[60] flex flex-col text-black",children:[e.jsx("div",{className:"bg-gradient-to-r from-[#10b981] to-[#34d399] text-white px-5 py-6",style:{paddingTop:"calc(var(--sat) + 1rem)"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold",children:r.name}),e.jsx("button",{onClick:()=>$(!1),className:"w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white text-xl",children:"Ã—"})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-2xl font-bold mb-4 text-[#10b981]",children:"Ingredients"}),e.jsx("ul",{className:"space-y-2",children:((G=r.ingredients)==null?void 0:G.map((s,t)=>e.jsxs("li",{className:"flex items-start text-lg",children:[e.jsx("span",{className:"text-[#10b981] mr-2",children:"â€¢"}),e.jsx("span",{children:`${s.amount} ${s.unit} ${s.item}`.trim()})]},t)))||e.jsx("li",{className:"text-gray-500",children:"No ingredients available"})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl font-bold mb-4 text-[#10b981]",children:"Instructions"}),e.jsx("ol",{className:"space-y-4",children:((_=r.instructions)==null?void 0:_.map((s,t)=>e.jsxs("li",{className:`flex p-4 rounded-lg ${t===a?"bg-green-100 border-2 border-[#10b981]":"bg-gray-50"}`,children:[e.jsx("span",{className:"flex-shrink-0 w-8 h-8 rounded-full bg-[#10b981] text-white flex items-center justify-center mr-4 font-bold",children:t+1}),e.jsx("p",{className:"flex-1 pt-1 text-lg",children:s.replace(/\[|\]/g,"")})]},t)))||e.jsx("li",{className:"text-gray-500 p-4",children:"No instructions available"})})]})]})]}):e.jsxs("div",{className:"fixed inset-0 bg-white z-[60] flex flex-col text-black",children:[X&&e.jsxs("div",{className:"fixed top-20 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 z-[60]",children:[e.jsx("span",{className:"text-2xl",children:"ğŸ”Š"}),e.jsx("span",{className:"font-bold",children:"SPEAKING"})]}),f&&e.jsxs("div",{className:"fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 z-[55] animate-pulse",children:[e.jsx("span",{className:"text-2xl",children:"ğŸ¤"}),e.jsx("span",{className:"font-bold",children:"LISTENING"})]}),f&&e.jsxs("div",{className:"fixed top-32 left-4 right-4 bg-black/90 text-white p-4 rounded-lg z-[70] text-xs",children:[e.jsx("p",{className:"font-bold text-green-400",children:"ğŸ¤ LISTENING"}),e.jsxs("p",{className:"mt-2",children:["Last heard: ",C||"nothing yet"]}),e.jsx("p",{className:"mt-2 text-yellow-300",children:'Try saying: "Quick Dish Next"'})]}),C&&e.jsxs("div",{className:"bg-blue-500 text-white px-4 py-2 text-center text-sm",children:['Heard: "',C,'"']}),e.jsxs("div",{className:"bg-gradient-to-r from-[#10b981] to-[#34d399] text-white px-4 sm:px-6 py-4 pt-[calc(env(safe-area-inset-top,0px)+1rem)]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("button",{onClick:L,className:"w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white text-lg",children:"â†"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:L,className:"w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white",children:e.jsx(re,{size:20})}),e.jsx("button",{onClick:()=>$(!0),className:"w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white text-lg",children:"â˜°"})]})]}),e.jsx("h1",{className:"text-xl sm:text-2xl font-bold mb-2",children:r.name}),e.jsx("div",{className:"bg-white/20 h-1.5 rounded-full overflow-hidden mb-2",children:e.jsx("div",{className:"bg-white h-full transition-all duration-300",style:{width:`${se}%`}})}),e.jsxs("p",{className:"text-sm opacity-90",children:["Step ",a+1," of ",r.instructions.length]})]}),e.jsxs("div",{className:"p-4 sm:p-6 md:p-8 bg-white flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 bg-[#10b981] rounded-full flex items-center justify-center text-white text-xl sm:text-2xl font-bold shadow-md",children:a+1}),e.jsxs("span",{className:"text-sm font-semibold text-gray-500 uppercase",children:["Step ",a+1]})]}),e.jsx("p",{className:"text-lg sm:text-xl md:text-2xl leading-relaxed text-gray-900 font-medium mb-6",children:A}),K.length>0&&e.jsxs("div",{className:"mb-6 p-6 bg-green-50 rounded-xl border-2 border-green-200",children:[e.jsx("h3",{className:"text-[#10b981] text-xl font-bold mb-4",children:"You'll need for this step:"}),e.jsx("ul",{className:"space-y-2",children:K.map((s,t)=>e.jsxs("li",{className:"text-lg text-gray-700",children:["â€¢ ",s.amount," ",s.unit," ",s.item]},t))})]}),M.length>0&&!ne&&e.jsx("div",{className:"mt-6 flex flex-col gap-3",children:M.map((s,t)=>e.jsxs("button",{onClick:()=>U(a+1,s),className:"w-full h-12 sm:h-14 bg-[#10b981] text-white rounded-xl font-semibold text-base sm:text-lg shadow-lg hover:bg-[#059669] transition-all",children:["Start ",s," Minute Timer"]},t))}),O&&e.jsxs("div",{className:"mt-6 space-y-3",children:[e.jsx("button",{onClick:ee,className:`mt-4 w-full h-14 rounded-xl font-semibold border-2 transition-all ${f?"bg-red-500 text-white border-red-600 hover:bg-red-600":"bg-green-50 text-green-700 border-green-200 hover:bg-green-100"}`,children:f?e.jsx(e.Fragment,{children:"ğŸ›‘ Stop Voice Control"}):e.jsx(e.Fragment,{children:"ğŸ¤ Enable Voice Control"})}),f&&e.jsxs("div",{className:"mt-4 p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200",children:[e.jsx("h3",{className:"text-lg font-bold text-blue-900 mb-3 flex items-center gap-2",children:"ğŸ¤ Voice Commands"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600 font-mono",children:"ğŸ"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:'"Quick Dish Start Recipe"'}),e.jsx("p",{className:"text-gray-600 text-xs",children:"Start from beginning with audio"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600 font-mono",children:"â¡ï¸"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:'"Quick Dish Next"'}),e.jsx("p",{className:"text-gray-600 text-xs",children:"Move to next step"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600 font-mono",children:"â¬…ï¸"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:'"Quick Dish Back"'}),e.jsx("p",{className:"text-gray-600 text-xs",children:"Go to previous step"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600 font-mono",children:"ğŸ”"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:'"Quick Dish Repeat"'}),e.jsx("p",{className:"text-gray-600 text-xs",children:"Read current step aloud"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600 font-mono",children:"â±ï¸"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:'"Quick Dish Start Timer"'}),e.jsx("p",{className:"text-gray-600 text-xs",children:"Start timer for current step"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600 font-mono",children:"âœ…"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:'"Quick Dish Done"'}),e.jsx("p",{className:"text-gray-600 text-xs",children:"Finish recipe and exit"})]})]})]})]})]})]}),w.length>0&&e.jsxs("div",{className:"bg-green-50 border-t-2 border-green-200 p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-green-800 mb-2",children:"Active Timers:"}),e.jsx("div",{className:"space-y-2",children:w.map(s=>e.jsxs("div",{className:"bg-white rounded-lg p-3 flex items-center justify-between shadow-sm",children:[e.jsxs("span",{className:"font-medium text-gray-700",children:["Step ",s.stepNumber]}),e.jsx("span",{className:"text-2xl font-bold text-green-600",children:J(s.remainingSeconds)}),e.jsx("div",{className:"flex gap-2",children:s.remainingSeconds>0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>s.isRunning?q(s.id):H(s.id),className:"text-sm text-gray-600 px-2",children:s.isRunning?"Pause":"Resume"}),e.jsx("button",{onClick:()=>Y(s.id),className:"text-sm text-red-600 px-2",children:"Cancel"})]})})]},s.id))})]}),e.jsxs("div",{className:"flex gap-3 p-4 bg-white border-t border-gray-200",style:{paddingBottom:"calc(env(safe-area-inset-bottom, 0px) + 3rem)"},children:[e.jsx("button",{onClick:V,disabled:a===0,className:"flex-1 h-12 sm:h-14 bg-gray-100 text-gray-700 rounded-xl font-semibold text-base sm:text-lg hover:bg-gray-200 disabled:opacity-50",children:"BACK"}),e.jsx("button",{onClick:W,disabled:a>=r.instructions.length-1,className:"flex-1 h-12 sm:h-14 bg-[#10b981] text-white rounded-xl font-semibold text-base sm:text-lg shadow-md hover:bg-[#059669] disabled:opacity-50",children:a===r.instructions.length-1?"DONE!":"NEXT"})]})]})};export{he as default};
